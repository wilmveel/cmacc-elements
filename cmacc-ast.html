<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-signals/iron-signals.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">

<dom-module id="cmacc-ast">

    <template>

        <iron-ajax
                id="ajax"
                url="{{file}}"
                method="POST"
                content-type="text/plain"
                on-response="handleResponse"
                debounce-duration="300"></iron-ajax>

        <paper-toast id="toast" text="Saved succesfull"></paper-toast>

    </template>

</dom-module>


<script>

    var state = {
        file: null,
        ast: null
    }

    Polymer({
        is: 'cmacc-ast',

        properties: {
            file: {
                type: String,
                observer: 'compose'
            },
            ast: {
                type: Object,
                notify: true
            }
        },

        ready: function () {
            console.log(state)
            if (state.file)
                this.file = state.file;
            if (state.ast)
                this.ast = state.ast;
        },

        compose: function (file) {
            state.file = file;
            window.cmacc.compose(file, null, function (err, ast) {
                state.ast = ast;
                this.ast = ast;
            }.bind(this))
        },

        parse: function (source) {
            window.cmacc.compose(source, null, function (err, ast) {
                state.ast = ast;
                this.ast = ast;
            }.bind(this))
        },

        find: function (key) {
            return window.cmacc.helper.queryAst(this.ast, key);
        },

        change: function (key, value) {
            var ast = window.cmacc.helper.queryAst(this.ast, key);
            ast.val = value;
            this.fire('iron-signal', {name: 'cmacc-ast', data: this.ast});


        },

        save: function () {
            cmacc.serialize(state.ast, function (err, text) {
                this.$.ajax.body = text;
                this.$.ajax.generateRequest()
            }.bind(this))
        },

        handleResponse: function () {
            this.$.toast.open();
        }
    })
</script>