<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="./cmacc-ast.html">
<link rel="import" href="./cmacc-sidebar.html">

<link rel="import" href="./cmacc-variable.html">
<link rel="import" href="./cmacc-section.html">

<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<dom-module id="cmacc-edit">
    <template>
        <paper-textarea value="{{source}}" on-input="compile" focused="{{focused}}" ></paper-textarea>
        <paper-toast id="toast"></paper-toast>
    </template>
</dom-module>


<script>

    Polymer({
        is: 'cmacc-edit',

        properties: {
            file: {
                type: String
            },
            ast: {
                type: Object,
                notify:true,
                observer: 'refresh'
            },
            err:{
                type: String,
                notify:true
            }
        },

        refresh: function () {
            if(!this.focused)
                this.source = this.ast.src;
        },

        compile: function () {

            var path = cmacc.resolve(this.file, '.');

            var options = {
                path: path
            };

            window.cmacc.compose(this.source, null, options, function (err, ast) {
                if (err) {
                    this.$.toast.text = 'Error: ' + err;
                    this.$.toast.open();
                    this.set('err', err);
                    this.set('ast', ast);
                } else {
                    this.$.toast.text = 'Compile Success';
                    this.$.toast.open();
                    this.set('err', null);
                    this.set('ast', ast);
                }
            }.bind(this));

        }

    });
</script>