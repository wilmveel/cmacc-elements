<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="./cmacc-ast.html">
<link rel="import" href="./cmacc-sidebar.html">

<link rel="import" href="./cmacc-variable.html">
<link rel="import" href="./cmacc-section.html">

<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<dom-module id="cmacc-edit">
    <template>
        <paper-textarea value="{{source}}" on-input="save"></paper-textarea>
        <paper-toast id="toast" ></paper-toast>
    </template>
</dom-module>


<script>

    Polymer({
        is: 'cmacc-edit',

        properties: {
            ast: {
                type: Object,
                observer: 'refresh'
            }
        },

        attached: function () {
            document.addEventListener('cmacc-changed', function (e) {
                this.refresh()
            }.bind(this))
        },

        refresh: function () {
            window.cmacc.serialize(this.ast, function (err, text) {
                this.source = text;
            }.bind(this))

        },

        save: function () {
            var options = {
                path: '/doc/'
            };
            window.cmacc.compose(this.source, null, options, function (err, ast) {
                if(err){
                    this.$.toast.text = 'Error: ' + err;
                    this.$.toast.open();
                }else{
                    this.$.toast.text = 'Compile Success';
                    this.$.toast.open();
                    this.fire('cmacc-ast', ast);
                }
            }.bind(this));

        }

    });
</script>