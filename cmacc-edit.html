<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="./cmacc-ast.html">
<link rel="import" href="./cmacc-sidebar.html">

<link rel="import" href="./cmacc-variable.html">
<link rel="import" href="./cmacc-section.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<dom-module id="cmacc-edit">
    <template>

        <iron-ajax
                id="ajax"
                url="{{file}}"
                handle-as="text"
                last-response="{{src}}">
        </iron-ajax>

        <paper-textarea on-input="compile" value="{{src}}" focused="{{focused}}"></paper-textarea>

        <paper-toast id="toast"></paper-toast>

    </template>
</dom-module>


<script>

    Polymer({

        is: 'cmacc-edit',

        properties: {
            file: {
                type: String,
                observer: '_fileChange'
            },
            src: {
                type: String,
                notify: true
            }
        },

        ready: function(){
            document.addEventListener('cmacc-save', function(){
                console.log('SAVESAVE');
            })
        },

        _fileChange: function(){
            this.$.ajax.method = 'GET'
            this.$.ajax.generateRequest();
        },

        compile: function () {

            var path = this.file.split('/').slice(0, -1).join('/');

            var options = {
                path: path
            };

            try {
                window.cmacc.compile(this.source, options);
                this.$.toast.text = 'Compile Success';
                this.$.toast.open();
            } catch (e) {
                this.$.toast.text = 'Error: ' + e + ': ' + e.file;
                this.$.toast.open();
            }

        }

    });
</script>